<?class
	 		 	  	GlobalScanApplications
	  	  	 	 	 		 	   extends
   				   GlobalScanEntity
		 	  	 		  	  			{
 	  				 	  			 	 private
  	  		 	$isDetailSwitchEnabled
       		  	 	  	=
   				   true;
 			 	    			 		public
 				 		 	  	 	function
      __construct()
		  			 	 	 		 {
  		 	 	 		  	 parent
	 			   	  	 			::
			 	__construct();
  	 	 	  		  	  		$this->headingName
 							   	=
  					    	 			   	"Global Scan - Applications";
			 	     			  	
	 	  			  		  	
 		 		  	   				$this->setSection("GlobalScanApplications");
  	  		}
		 		  protected
	 	 	  	   	 	 	 		 function
				   renderView()
  	 	 	 	 			 	{
	 	 		 	print("<div class='Info'>This is the renderView</div>");
		  		  	 			 	  }
	 	  		  		 	 			 	public
   							 	  		 function
  	 	displayDetailedHeader(){
			 			  		 		   ?>
	  <tr class="ColumnHead">
	    <td class="SummaryRow" width="5%">&nbsp;</td>
	    <td class="SummaryRow" width="25%" align="left">Application Name</td>
	    <td class="SummaryRow" width="25%" align="left">Description</td>
   	    
		<td colspan="2"class="SummaryRow" align="left" width="30%">Monitor Information</td>
	  </tr>
<?
    	 	    	 		}
  		  					 				  public
	 				 		function
			 		 	   		  	renderList()
     						{
			 		     	$applications
			  	=
   			 		 	$this->getFormattedApplicationArray();
			 		 			   				 $applicationStatuses
   		 		 	=
     			$this->getApplicationStatuses();
 		  			 		   	 	$expandedview
  	   		=
 			  		 	 	 			false;
 	 		  				  	  if
						  (isset
  	  	 		  			  	($_REQUEST['view']))
 				  			 	 {
     	 	    	    	  if
	   			 	  	($_REQUEST['view']
				   ==
	   			  		 		"detailed")
 	   	 			 	  				 	{
	 				 	  	 	   	$expandedview
	 	 	      			 		 	 =
	   			true;
  			 	 	}
	  	 					  }
	 				  ?>

<table border=1 cellpadding=4 cellspacing=1 width=100% frame="void" rules="rows">

<?
   	 		 	 	 	 if
 	   	 	(!$expandedview)
 	 	 		  	 	{
 	   			 ?>
	  <tr>
	<td width="2%" align="left"></td>
	    <td width="25%" align="left"></td>
	  </tr>

<?
 	   		 }
  			 if
 	 		   (!$applications)
 	    	 	  									{
	  	 	 $addApplicationLink
			  		 	=
			 		  	 GUIUtil::createLink("Add Application",
			 	  	"/main.php?page=MyInfrastructureSection",
	 						"_top");
 				 	echo
						 	  			"<tr><td class='Info' colspan=\"5\"><b>You currently don't have any applications defined.  Go and ".$addApplicationLink.".</b>";
	  				 	}
 	   	  	foreach
	 	  			 		 	($applications
		  		  	 					 	as
 		 		 		$appName
		  			 	 	 	 	=>
 	 					  	 $rows)
		 			  	 							{
	 		   		 $isReplicatedApp
		  		 	=
  				 	 		  		   		isset($rows[0]['is_replicated'])
		  	  		&&
		   	  $rows[0]['is_replicated']=='true';
	 	    				$backgroupClass
 	 		 		  			 		  =
	 		  	  '';
 	 	   				  	   	 	$imageTag
  		 		 =
	      '';
 	 	  	  	  	 if(isset($applicationStatuses[$appName]))
  	 	 	 			  {
     							 	    $highlter
	  		      	  		 		=
		 	 	 new
	 		        GlobalScanStatusHighligher($applicationStatuses[$appName]['status']);
	 		     			  	 	 	 $backgroupClass
 		 					 =
 	 	      $highlter->getBackgroundClass();
		  	   			 $imageTag
 		       =
	  		  		$highlter->getImageTag();
		 				 }
 	   				 				   		 $description
			  	  			=
	      	 	   	 "--";
 	    	 	 	 		 if(isset($applicationStatuses[$appName]))
 		  {
 			    			$description
  	   	 	  			 =
		 		 		   	$applicationStatuses[$appName]['description'];
  		  					 	 	}
				     	 	 		  if
			  		    	 	 		  	(!$expandedview)
   						 {
	  		 $masterStatusTag
 	    		=
   				 		 		"";
 		  	  	   	 			 	$mastericonOk
 				  			 	 	=
	  	 				 "";
				 	 		 	 	 		   	$mastericonWarn
   		 		  	   	 		=
	 		 "";
 			   		 				      $mastericonCrit
	  		  	  	 	=
				 	  	 		 						 "";
 		  		  $masterIconMaint
 		       	   	 	=
			  				 "";
		 		$mastericonUnknown
 			  						 	    	=
		 		  		 	 		"";
	 		 $statusTag
	    	   					=
 	  		 "";
		   	 	 	 		 $iconOk
	 	 	   		 	 		=
  						 		 			 	"";
		  	  $iconWarn
   			    	 	=
        	 "";
 			 	 	  		   $iconCrit
		 		 	=
				  				  		"";
 				 	  					 $iconMaint
 				 	=
  	    				 		 "";
		 		 	 	 		 		   $iconUnknown
	  	 	  =
		  		 	     	  "";
 		  	   					foreach
 	 	  	 		($rows
 			   	  	   		  as
	 	  		    $erdc)
 				  			   	     {
	   		   	   			 		if($isReplicatedApp)
	 	  	 		 		  					 {
	    		   	 
	    			     	
      		 continue;
 		    }
	  		 	 	switch
	  		 	     ($erdc['status'])
   		 	 			  		  	{
     			 case
	 				   	'OK'
	  				   				  		 :
		  	$image
	 	 	   	    			 			=
	 			   	"<img src=\"/images/service-status-ok.gif\" alt=\""
 	  	 		    		.
  	 	 	 $erdc['erdcname']
	 	  		 					.
 	 					 "\">";
  	 		 					  		 	 if
 	 	  	($erdc['hostcheck']
 		   ==
  	 		 		'true')
 		 					{
 	 	   		  	   $mastericonOk
	  	  	 								  .=
  		  $image;
		   		 }
 								   				   	else
							   		    	 	{
	   	 	  		  	 		$iconOk
		  		   		.=
 		    			  $image;
  	 	 	    	    			 }
		  	  		 	   		  break;
	 		 				   			 	 case
   		  'CRIT'
 	   	:
 	  	 					 		$image
		 	   	 =
 	 	 	 	"<img src=\"/images/service-status-critical.gif\" alt=\""
     	  .
	   				 	 	   	 	$erdc['erdcname']
 	  		 	  	.
	  		"\">";
	   	if
   			 			 ($erdc['hostcheck']
				 ==
   	 	     			 	   'true')
	   	 {
 	 	 	 	$mastericonCrit
		  	  .=
   		 	  		$image;
		 				}
		 		 				else
   			   			 {
 			   	 	 	  		  $iconCrit
		 	 		 .=
  		  		  	   	$image;
   			    		   }
	 	 					 					  	break;
 		  case
		 				 		 	 	'WARN'
    	 	 		 :
 	   					$image
  			   	  		   			 =
	      				 "<img src=\"/images/service-status-warn.gif\" alt=\""
 		 			   	  				.
	 	 	 		$erdc['erdcname']
		 	    .
 	 		 					  		  		"\">";
 	 	 	 		if
	 	 	 	 	 	($erdc['hostcheck']
   		  		 	==
 					 	 	  	 	  'true')
	 		  	 	 	{
  	  		 $mastericonWarn
						 		  		.=
 	  			   					 $image;
 	  	 			 		  	 }
 		  		 	  		 		  		else
      			 	 	 		 {
	     		$iconWarn
  			  .=
			    	     		$image;
			 			 	}
 	   	  		 	break;
		     			case
 	    			 	  'MAINT'
 		  				 	       :
    	    		 		  	 $image
	     		=
     			 	"<img src=\"/images/service-status-maint.gif\" alt=\""
  	 			  				    		 .
	 	   		 	 		  	 		$erdc['erdcname']
   	 			  					 	 	.
 	   	 	  "\">";
	 						  		 		 		if
	  	 			   	 		 		 ($erdc['hostcheck']
      			    	==
 			 'true')
			 	     	 	  		 {
   	  	 	$masterIconMaint
			  		  	 			 .=
	   		  		 $image;
   	    }
 					 	 	 				else
 	 		 	{
 		 				$iconMaint
 			   	 	.=
 		       		 	 	 	$image;
	   	    }
   		 		 	 	break;
	   	 								default
 	   :
				   	$image
        			 	   	 =
   				  	  	"<img src=\"/images/service-status-unknown.gif\" alt=\""
 			 	 	 			   		.
			 	 			 	 			 	$erdc['erdcname']
 	 	 				  .
	 				 	   			  	"\">";
  	  	    	  		if
  	 		 	 	  ($erdc['hostcheck']
   		  	==
	  				'true')
	   		  {
		 			 	$mastericonUnknown
					     	   					.=
   	 		  		   	  		$image;
 	 	 		 				 	}
	  			 else
	 	  	 				 	{
			 		 $iconUnknown
				  		 				 	 		.=
 			    				 	  	$image;
			    	      		 		}
		 	  	    	   				break;
				 	     }
	 			  	}
 	 		 	 	  	 			 	$statusTag
			 		 		 =
  	 						   $iconOk
						 	.
	 		 	   		 	 	  	 $iconWarn
 			 	 		  	 .
		 	 		 	  	$iconCrit
	  	 .
  			 $iconMaint
   	 	 	  .
		 	 	$iconUnknown;
	 	   		 	 			      $masterStatusTag
 	 	   		 			 		 =
  	 	 	 			 		  				$mastericonOk
	  				  	.
    	    	 		   $mastericonWarn
	 	  	 	  	 	 	  		.
  		  			 		   					$mastericonCrit
	 		   .
 		 	 $masterIconMaint
  	 	  		.
	 		  	 			 	 		$mastericonUnknown;
	   		  						 			}
  		 		 	else
  	 				   	  	  {
  			$statusTag
    	 	 	    	 =
	 	 				 						  	 "&nbsp;";
	 	   		     	 		 	$masterStatusTag
	 		  	  =
   	  	  	 	 	 "&nbsp;";
				 	  	 		   		}
 	   	  	  
 		  	 			  			 	
    	  	   	   
 		  		 
       	  	
  		  
 			 	  		  if
 	  	 			($isReplicatedApp){
 		  	$ldcUrl
	 		   				 			=
 	 	 	  			    $rows[0]['ldc_url'];
    					$ldcTarget
 	  	 		 	  	  		=
 	   		$rows[0]['linktarget'];
	  	  				 $ldcCLickThru
			 		  	 			 	=
		 			     "<a href='$ldcUrl' target = '$ldcTarget'>View Details on Local Datacenter</a>";
  	   $replicatedMessage
   		 			 	=
	   	 			 			 $rows[0]['message'];
 				   	   		 	    if
	    	   					($expandedview)
	 	  {
 	 		 	 $masterStatusTag
 		  			  						=
 			 	 	 	  $ldcCLickThru;
	 	   		     		$statusTag
  		 		     	 =
 	 			         $replicatedMessage;
	     		 	   	  				}
	 	 		 			  		 		  else
     	  		 			  	 		{
	 		 		  	 		  	 	 	$masterStatusTag
 	 	 			 =
	  	   		 		  $replicatedMessage;
   	 	 	  	 	 	 	  	$statusTag
  	 			 		  =
		    	 '';
				 			 		 }
	 				 	 	    	  	 	if
 	  	($expandedview)
	  		   	 	   {
  		 	$this->displayDetailedHeader();
		 			}
  	  		 		$this->renderApplicationInfoLine($imageTag,$backgroupClass,
 	  	  $appName,
  	  		 			 	 	 		 $description,
	 	     $masterStatusTag,
 		  							$statusTag);
	 	    		 	}else{
   	 	if
 				   			 		 	($expandedview)
	   				  					 {
				  							 $this->displayDetailedHeader();
					 			}
   	 		$this->renderApplicationInfoLine($imageTag,$backgroupClass,
  	 			 		 	  	 $appName,
   	 		   			   $description,
			  	 	 	 	  	$masterStatusTag,
		  	    	  		  		  $statusTag);
 	 	  	    }
 	 		if
 		 	($expandedview)
       					{
      	 	   	  	  	foreach
	 			 ($rows
		  		 	  		 as
 	 		$erdc)
			 	   			 	 {
 	 			 	 			 	 	 	if
  		  	  	  	(!$isReplicatedApp){
 	  		 	  		  	 	$this->renderDetailedRow($erdc);
 	 			 		 	       }
			 	 	  	 			}
					 	   	}
			 	 		}

	   	  	?> 
<tr>
<td width="1%">
</td>
</tr>
</table>

<?
  			  DeprecatedUi::renderFooter();
	 	  					 	}
 				  	 				 	 	private
		      	  	      function
 	 	  	renderContentHeading($expandedview){
 			 	 				$buttonHtml
		 	 				  	 		 =
	  	 '';
	  						  if
  		 ($this->isDetailSwitchEnabled)
		 			       		  {
			  	 	 	 		 				  $buttonLink
     =
  			   	  '/main.php?section=GlobalScanApplications&subsection=list';
     if
 			 		   ($expandedview)
 	 	    	 {
	   			 		  $buttonLabel
 				   	=
  	   				  				   'Show Condensed View';
			   		 	 }
  			   			 	  					else
   	 		  {
	 	 			 			 	 $buttonLabel
   	   	=
		   		'Show Detailed View';
	  	 		$buttonLink
 			 .=
	   	'&view=detailed';
  			 		 }
		  	 		  	$buttonHtml
 	  				=
  		       "<td class='TitleButtons'><a class='FormButton' href='$buttonLink'>&nbsp;$buttonLabel&nbsp;</a>&nbsp;</td>";
	 	      }
 		  ?>
	<tr><td colspan=5>

		<table  width="100%" border="0" cellspacing="0" cellpadding="0">
		  <tr> 
			<td class="TitleBar">Application Status</td> 
			<?=
  		 			 		$buttonHtml
	   		  	  	 	  			?>
		  </tr>
		</table>

	</td></tr>
	<?
	  	 		  	 }
 	 		   		 	 							private
 		  			function
 				 		  						renderDetailedRow
		 	   		      	 	($erdc){
  							  					  		$referenceAddr
		    						  =
  			 	 		 	 		 		 	"/main.php?section=Profile&subsection=&id="
 	 	 .
		  		  		 $erdc['entityid']
 		 			   						.
 	 		  	"&name="
 				 .
	 	 	$erdc['entityname']
				 		 		 			  	.
			  		"&dlsection=s_status";
    	 	   		 	 	 	 	$erdcName
 				 	    				 	  =
    	Utf8Utils::htmlentities($erdc['erdcname']);
					 	  			 	 	$elementName
 	    		 	=
  	           	Utf8Utils::htmlentities($erdc['entityname']);
	 				 		 		  		 if
		   	   (isset
	  	  	 	 	  	 	   ($erdc['hostcheck'])
		   		 &&
 				 				 				$erdc['hostcheck']
		 	 ==
    		  	  	 	 	 	'true')
  	 		  		 		{
  		 		   				$erdcName
    	      			     =
 			 			 	  '*&nbsp;'
 	  				  	  	.
 			  					 		   		$erdcName;
	    								  }
		 	     	    if
	  	 ($erdcName
     			  	   			 ===
 	 	   	 			'')
 		  	 {
     		 	 	 			 	 	$instanceTag
 			  	 	 	  		  			=
 	  	 '&nbsp;';
			 			  			 }
 		  		   		 	 		   else
	 	 	 	   	{
	 	 	 			 	 	if
 	 	  	  	   ($erdc['has_permission']
 		 		 	   	 	==
		  	    	 	 	'true'
    	 &&
  			 	  		 	 $this->isDetailSwitchEnabled)
 		  	 		{
	 		   				$instanceTag
		 		   	  	=
   	  	 		"<a target=\"content\" href=\""
		 	   .
	 		 		 		   		   	$referenceAddr
		 	   	 .
			    	 	"\">"
	  		      	.
	 	 	 		 							  	 $erdcName
	 	  		 						  	 	 .
 	  	  			    			  	"</a>";
  		  	 			  	  	}
   			 		  else
	  				 	    	    {
 	 	    		$instanceTag
  	 	    	=
	 	  		 		  	$erdcName;
 		 	   }
		  		 		  	  	}
     	 			   $erdcdesc
     	  	=
  	  	     	 	 Utf8Utils::htmlentities($erdc['description']);
    			if
 	   	 	 				  			 ($erdcdesc
  		 	 	==
  					"")
 	  	  	   	 		{
	  		  	 		$erdcdesc
	    	=
 	 		   			 	  			 "--";
 			 	 	 	}
	  	 	  	$monitorInformation
      				 	  =
 			 $erdc['currentoutput'];
    	 ?> 
	
	<tr >
		<td width="5%">&nbsp;</td>
		<td width="20%"  class="info" ><img src="/images/<?=
  	 	$this->getStatusIcon($erdc['status']);
 					  	 ?>">&nbsp;&nbsp;<?=$instanceTag?></td>
		<td class='info'><?=$erdcdesc?></td>
		<td class='info'><?=$elementName?></td>
		<td class='info'><?=$monitorInformation?></td>
	</tr>
<?
	  	 	 		}
				 	  	 		 private
 				function
		 		 		   		getStatusIcon($status){
	 	 	      	switch
 	     		  ($status)
	 	    {
 	 		 		 		  case
 		 	 			'OK'
 	     		   	     	:
   		    			$icon
		  			   =
	 	       		      	"service-status-ok.gif";
	 		 	 		   break;
  	       	  		  case
	  	  	  			 'CRIT'
	    					    		 :
  		 		 $icon
 	 	 		 		  		  	=
	  	  	 "service-status-critical.gif";
   		 	break;
		   	  		  	 			 case
	   	   		 		  	'WARN'
	 		 	  	  		  	:
  	  	 		 			 	$icon
	 	      =
 	 			"service-status-warn.gif";
	 			break;
	   			 		  		   	case
			  	  'MAINT'
  			  				  	 			 :
  							 	$icon
		  					=
	  	 		"service-status-maint.gif";
	     		 	 	 break;
	  	   	 	default
				 		:
  					    $icon
	 		 	  		 	  		=
	 	   	 		  	  		 "service-status-unknown.gif";
				   	 		 	      break;
		 	   }
     		 		   return
 		   			  		 $icon;
 	 	 	 	   	 	 		}
		 	  	  	  		 private
 	 	 		   	  				   function
   	 		 	 		  			 renderApplicationInfoLine($imageTag,$backgroupClass,
 			 	$appName,
				   				$description,
		  	 	 	  	  	 	$masterStatusColumn,
	 		  $regularStatusColumn){
 	 	    				?>
	<tr >
		<td class="SummaryRow" width="1%"></td>
		<td class="<?=
   		 		$backgroupClass?>" width="15%" align="left"><?=Utf8Utils::htmlentities($appName)?></td>
		
        <?
						     		  	 	 if
	   				  	(!$regularStatusColumn){
 	 		 print
	 				  			 "<td class=\"SummaryRow\" align=\"left\" width=\"20%\"  colspan='2'>$masterStatusColumn</td>";
    		 }
	  		 		  			 			  	else
	 				  {
				  				print
		 			   	 	  "<td class=\"SummaryRow\" align=\"left\">$masterStatusColumn</td>";
   			   	 	print
 						 "<td class=\"SummaryRow\" align=\"left\" width=\"30%\">$regularStatusColumn</td>";
 			 	     	 			  	}
	 		     		 	  ?>
	</tr>
    	<?
	  	 }
	     function
	 	   	 	    	getFormattedApplicationArray()
	  	 	 	 		  		{
 				    	 	
	  	  					    		 
	 		 $dl
 				 	=
		 						  	  		new
			   		DataLoader();
 			  	  	 $rs
 				  			=
	 			   				$dl->query("GET_ALL_APPLICATIONS");
    		  	   	 
	  						
	  		 	 	 		  				$applicationsByName
	  	 	 =
 	  	 				    	 	 	array
	     		 				    	 ();
 		   	  	  while
	 	  	 					($rs->hasNext())
        	   	 {
 						 					$row
	  			  =
			 		  		 $rs->getNext();
	   		 		 	 	  	 	 $appName
		   		 	   	    =
  		 	  	$row['appname'];
		 	  		 if
	  	 	 	  		    		(isset
   	  			    	($applicationsByName[$appName]))
  			  	   			 			{
  				 $currentArray
	 	   		 	=
 	  			$applicationsByName[$appName];
   	  	 }
		  				  		else
  	  	{
 	 	  	    	$currentArray
		 		 					 	=
	   	 			     			array
 	 	 			  		 ();
			  	 }
	 		  		 $currentArray[]
   				=
		 		 	 	 		   		 	$row;
		  	 	 		   $applicationsByName[$appName]
		 	 	    	 	 		 		=
  	 	$currentArray;
	 	   		 		  }
   		    	 		 		return
		 	 		  			 		    	$applicationsByName;
	  	 	  			 	 			}
      	  	 	private
							  	static
  	  	 		 	 		function
	 		    	 			   	 	compareErdcs($a,
 	 		 	 	 			  	 $b)
  			 	  				 	{
			  if
 	 				  		 		($a['hostcheck']
								  				     ==
 		 			 	   'true'
	   	  	&&
	 		 	   		$b['hostcheck']
 		 	  		 !=
			  	'true')
  	 			{
	    	 		 	 return
	  		 			 	  -1;
		  	 	   	 	 }
	 		 					   		   		if
 	   				 	 	  	 	  ($b['hostcheck']
	    		  	   	==
	 				 'true'
 	 		 		 			 	 	&&
 		  				 $a['hostcheck']
 	 	 		    	 			 !=
		  	     	   	   	'true')
 		  		{
	  				return
	  	  1;
	 	 	 	  	}
	  	  	   	   	return
 		 	  			($a['erdcname']
	   	 	 				  	  <
				   			  	$b['erdcname'])
		 		  								   ?
		 	    	      	-1
 	 			    			:
 	 	 	1;
  	 				   	  }
		 		 		  	function
   	  	getApplicationStatuses()
			   		{
			 	 	$dl
 	  			   	    			  =
				  	new
 	   	 	 	  		   DataLoader();
	  		$rs
	    	 	 =
  					 		   $dl->query("GET_APPLICATION_STATUSES");
  	   
	      	 	  
	  	 			$result
	  				     		  	 =
	 		 		 		array
 								   		();
 	 		 	 				 	    		while
  	 	($rs->hasNext())
	 		     {
  		 	 		 		$row
 					  		 =
		 			$rs->getNext();
 			 	   	 	    		 $appName
		  		  			 		 	 	 =
			  		 	$row['appname'];
 		     	 	$status
	  			 	=
 		 			 	 		  	    $row['status'];
	     		  		 			$description
     	  		   		 		 =
			  		 	 		  	 	$row['description'];
			 	 					   				$fields
 								  		    =
	     				 			 	 	array
   		  			  		 (
	  		 	'status'
  		  =>
 	  		   			 	    $status,
		   	 		 	 	 'description'
   	 	  								   	=>
		 	 	   						 $description
	  	 	 	);
			 			    	  	  	 $result[$appName]
					 		   			=
 		 	$fields;
		 			 						}
				   		return
					 	    		   	$result;
							  		 	 }
	   	   		 	  public
	  		 function
    				setDetailSwitchEnabled($enabled)
					 	  	 				{
	 		   		$this->isDetailSwitchEnabled
 	  						      			 =
			 				  		 				$enabled;
	  				 }
   	 	  	 	  	  	  }
     		  	  	?>
